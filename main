import pygame
import time
pygame.init()

pygame.display.set_caption("idle farmer")
screen = pygame.display.set_mode((1920, 1080))

background = pygame.image.load('bg.jpg')
background = pygame.transform.scale(background, screen.get_size())

from farmer import Player
from money_overlay import MoneyOverlay
from arbre import Arbre
from money_wood import MoneyWood

# groupes
arbre_group = pygame.sprite.Group()
arbre = Arbre(500,400)
arbre_group.add(arbre)

player = Player(45, 45)
money_overlay = MoneyOverlay()
money_wood = MoneyWood()

# Timer pour les dégâts
last_attack_time = 0
attack_cooldown = 0.1  # 0,5 seconde entre les dégâts

running = True
clock = pygame.time.Clock()

while running:
    dt = clock.tick(60) / 1000
    screen.blit(background, (0, 0))

    # temps actuel
    current_time = time.time()

    # mise à jour des arbres
    Arbre.update_famille(dt, arbre_group)
    for arbre in arbre_group:
        screen.blit(arbre.image, arbre.rect)
        arbre.draw_health_bar(screen)

    # récupérer l'état des boutons et position de la souris
    mouse_buttons = pygame.mouse.get_pressed()
    mouse_pos = pygame.mouse.get_pos()

    if mouse_buttons[0]:# clic gauche maintenu
        old_pos = player.rect.topleft
        player.move_towards(mouse_pos)
        player.rotate_towards(mouse_pos)

        # empêcher le joueur de traverser les arbres
        if pygame.sprite.spritecollide(player, arbre_group, False, pygame.sprite.collide_mask):
            player.rect.topleft = old_pos

        # appliquer les dégâts avec cooldown
        if current_time - last_attack_time >= attack_cooldown:
            for arbre in arbre_group:
                if player.rect.colliderect(arbre.rect):
                    arbre_dead = arbre.take_damage()  # retourne True si tué
                    if arbre_dead:
                        money_wood.money += money_wood.rendement_par_coup  # argent gagné uniquement si arbre tué
            last_attack_time = current_time


    # argent
    money_overlay.update(dt)
    money_overlay.draw(screen)
    money_wood.draw(screen)

    

    # afficher joueur
    screen.blit(player.image, player.rect)

    pygame.display.flip()

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
            pygame.quit()
            print("fermeture du jeu")

